# 해양레저스포츠 자율신고 MVP - Task 8: 실시간 기상·AI 리포트 통합

신고 완료 화면에 Windy / 공공데이터 API 기반의 실시간 기상 정보(바람, 돌풍, 파고 등)를 표시하고, 해당 데이터를 이용해 AI 안전 리포트를 자동 작성·저장하는 작업입니다.

**Push 단위**: Task 8 전체 완료
**목표**: 신고 결과 페이지에서 실시간 기상 데이터와 AI 분석 리포트를 함께 보여주고, 동일 데이터를 서버·AI 워크플로에 안전하게 공급
**배포 가능 여부**: ✅ 사용자에게 즉각적인 기상/안전 인사이트 제공

---

## 관련 파일
- `src/lib/services/weatherService.ts` - Windy Point Forecast + 파고 데이터 수집 로직
- `src/lib/services/publicDataService.ts` - 기상특보/해경 파출소 API 래퍼 및 거리 계산
- `src/lib/services/aiService.ts` - AI 리포트 생성 프롬프트 및 모델 구성
- `src/lib/services/reportService.ts` *(신규 예정)* - 신고 상세/기상/AI 데이터 통합 fetcher
- `src/app/report/result/[id]/page.tsx` - 신고 결과 페이지 UI
- `src/components/safety/SafetyAnalysis.tsx` - 안전 분석 카드 및 AI 리포트 UI
- `src/app/api/report/[id]/insights/route.ts` *(신규 예정)* - 신고+기상 통합 API (SSR/클라이언트 겸용)
- `src/lib/config/externalApis.ts` *(신규 예정)* - API 키/엔드포인트 정의
- `vitest.setup.ts`, `src/lib/services/__tests__/*.test.ts` - 서비스 단위 테스트
- `docs/비밀저장소/api_docs.md` - API 키 레퍼런스 (참조만)

---

## 작업
- [ ] 8.0 통합 설계 및 설정 정리
    - [x] 8.0.1 환경 변수/키 정리 (`.env.example`, `next.config.ts`) 업데이트
        - [x] 8.0.1.1 테스트 코드 작성
        - [x] 8.0.1.2 테스트 실행 및 검증
        - [x] 8.0.1.3 오류 수정 (필요 시)
    - [x] 8.0.2 외부 API 설정 모듈 (`src/lib/config/externalApis.ts`) 생성
        - [x] 8.0.2.1 테스트 코드 작성
        - [x] 8.0.2.2 테스트 실행 및 검증
        - [x] 8.0.2.3 오류 수정 (필요 시)

- [ ] 8.1 실시간 기상 데이터 서비스 구현
    - [x] 8.1.1 `weatherService`를 Windy Point Forecast + 파고 API로 교체하고 캐싱 추가
        - [x] 8.1.1.1 테스트 코드 작성
        - [x] 8.1.1.2 테스트 실행 및 검증
        - [x] 8.1.1.3 오류 수정 (필요 시)
    - [x] 8.1.2 공공데이터 특보/해경 정보 fetch 유틸 고도화 + 거리 계산 검증
        - [x] 8.1.2.1 테스트 코드 작성
        - [x] 8.1.2.2 테스트 실행 및 검증
        - [x] 8.1.2.3 오류 수정 (필요 시)

- [ ] 8.2 신고 통합 API 및 서비스 계층 추가
    - [ ] 8.2.1 `reportService`에서 신고 + 외부 데이터 + AI 입력을 통합 fetch
        - [ ] 8.2.1.1 테스트 코드 작성
        - [ ] 8.2.1.2 테스트 실행 및 검증
        - [ ] 8.2.1.3 오류 수정 (필요 시)
    - [ ] 8.2.2 `/api/report/[id]/insights` API Route로 보안 데이터 제공 (서버 전용)
        - [ ] 8.2.2.1 테스트 코드 작성
        - [ ] 8.2.2.2 테스트 실행 및 검증
        - [ ] 8.2.2.3 오류 수정 (필요 시)

- [ ] 8.3 신고 결과 UI/UX 개선
    - [ ] 8.3.1 `report/result/[id]/page.tsx`에서 기상 카드 + 특보 리스트 + 파출소 정보 섹션 추가
        - [ ] 8.3.1.1 테스트 코드 작성
        - [ ] 8.3.1.2 테스트 실행 및 검증
        - [ ] 8.3.1.3 오류 수정 (필요 시)
    - [x] 8.3.2 `SafetyAnalysis`에 AI 요약/리스크/권고 UI 확장 및 로딩 상태 처리
        - [x] 8.3.2.1 테스트 코드 작성
        - [x] 8.3.2.2 테스트 실행 및 검증
        - [x] 8.3.2.3 오류 수정 (필요 시)

- [ ] 8.4 AI 리포트 워크플로 강화
    - [ ] 8.4.1 `aiService` 프롬프트를 신규 데이터 포맷에 맞게 업데이트 + 모델 폴백 로직 정비
        - [ ] 8.4.1.1 테스트 코드 작성
        - [ ] 8.4.1.2 테스트 실행 및 검증
        - [ ] 8.4.1.3 오류 수정 (필요 시)
    - [ ] 8.4.2 신고 완료 시 AI 결과를 저장/재사용하도록 Supabase 업데이트
        - [ ] 8.4.2.1 테스트 코드 작성
        - [ ] 8.4.2.2 테스트 실행 및 검증
        - [ ] 8.4.2.3 오류 수정 (필요 시)

- [ ] 8.5 테스트 & 문서화
    - [ ] 8.5.1 Weather/PublicData/AI 서비스 단위 테스트 작성 (Vitest)
        - [ ] 8.5.1.1 테스트 코드 작성
        - [ ] 8.5.1.2 테스트 실행 및 검증
        - [ ] 8.5.1.3 오류 수정 (필요 시)
    - [ ] 8.5.2 통합 시나리오 E2E 테스트(Playwright) 추가: 신고→결과 흐름 검증
        - [ ] 8.5.2.1 테스트 코드 작성
        - [ ] 8.5.2.2 테스트 실행 및 검증
        - [ ] 8.5.2.3 오류 수정 (필요 시)
    - [ ] 8.5.3 README 및 `docs/`에 API 사용법/환경변수/운영 가이드 업데이트
        - [ ] 8.5.3.1 테스트 코드 작성
        - [ ] 8.5.3.2 테스트 실행 및 검증
        - [ ] 8.5.3.3 오류 수정 (필요 시)

---

## 데이터 흐름 설계 요약
1. **신고 데이터 로드**: Supabase `reports` 테이블에서 신고/위치/활동 상세를 조회.
2. **실시간 외부 데이터 수집**:
   - Windy Point Forecast API → `weatherService`에서 바람/돌풍/파고/너울 수치 추출.
   - 공공데이터포털 기상특보 API → 위험 경보 텍스트 수집.
   - 해경 파출소 위치 API (또는 캐시된 좌표) → 현재 위치와의 거리 계산.
3. **AI 리포트 생성**: `aiService.generateSafetyReport`
   - 입력: 신고 정보 + 실시간 기상 + 특보 + 근처 파출소 정보
   - 출력: 요약, 위험도, 리스크 요인, 권장 행동, 날씨 분석
4. **UI 표시**:
   - 기상 카드: 풍속/돌풍/파고/너울(실시간)
   - 특보 리스트 & 파출소 연락처 안내
   - SafetyAnalysis 컴포넌트 내 AI 요약 및 권고 섹션
5. **데이터 저장/재사용**:
   - AI 결과를 Supabase `reports.ai_summary`(가칭)에 저장, 재조회 시 재사용 (TTL 고려)
   - 외부 API 결과는 5~10분 메모리 캐시로 호출량 절감

---

## 보안 및 운영 고려사항
- Windy 및 공공데이터 키는 서버 사이드 환경 변수로만 로드 (브라우저 노출 금지)
- 실패 시 Graceful Fallback: API 오류 발생 시 이전 데이터 또는 기본 메시지 노출
- 외부 API 호출량 제한(분당 10회 이내)을 위해 좌표 단위 캐싱 적용
- AI 호출 실패 시 기본 안전 안내 문구 제공

---

## 테스트 전략
- 서비스 단위 테스트: axios 호출을 nock/vi.mock으로 모킹하여 데이터 파싱 검증
- 통합 테스트: 신고 더미 데이터를 Supabase 로컬/Mock으로 준비 후 결과 페이지 렌더링 검증
- Playwright: 신고 제출 → 결과 페이지에서 기상 카드/AI 섹션 노출되는지 확인

---

이 문서는 Task 8 진행 상태와 체크리스트를 추적하기 위한 기준 문서입니다.
