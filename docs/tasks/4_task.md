# Tasks_251119_04.md
# 해양레저스포츠 자율신고 MVP - Task 4: 지도 및 안전도 분석 시스템

**Push 단위**: 지도 연동 및 안전도 분석 완료  
**목표**: Kakao Map 연동, 안전구역 표시, AI 기반 안전도 계산  
**배포 가능 여부**: ✅ 지도에서 안전 정보를 시각적으로 확인 가능한 상태

---

## 관련 파일
- `src/components/map/MapView.tsx` - 메인 지도 컴포넌트
- `src/components/map/SafetyZones.tsx` - 안전구역 오버레이
- `src/components/map/MarkerManager.tsx` - 마커 관리
- `src/lib/config/map.ts` - Kakao Map 설정
- `src/lib/hooks/useMap.ts` - 지도 관련 훅
- `src/app/api/map/safety-zones/route.ts` - 안전구역 API
- `supabase/functions/analyze-safety/index.ts` - 안전도 분석 Edge Function
- `src/components/safety/SafetyAnalysis.tsx` - 안전도 분석 결과 UI
- `src/lib/services/safetyService.ts` - 안전도 계산 로직

---

## 작업

- [ ] 4.0 오픈스트리트맵 연동 및 지도 시스템 구축 (Push 단위)
    - [ ] 4.1 오픈스트리트 맵 설정 (커밋 단위)
        - [ ] 4.1.2 `.env.local`에 `NEXT_PUBLIC_KAKAO_MAP_KEY` 추가
        - [ ] 4.1.3 `src/lib/config/map.ts` 생성 - 지도 설정 (기본 중심좌표, 줌 레벨)
        - [ ] 4.1.4 `next.config.js`에 Kakao Map 스크립트 로딩 설정
        - [ ] 4.1.5 테스트 코드 작성: 환경 변수 로딩 확인
        - [ ] 4.1.6 테스트 실행 및 검증
        - [ ] 4.1.7 오류 수정 (필요 시)

    - [ ] 4.2 메인 지도 컴포넌트 구현 (커밋 단위)
        - [ ] 4.2.1 `src/components/map/MapView.tsx` 생성
        - [ ] 4.2.2 Kakao Map 초기화
            - [ ] 4.2.2.1 useEffect에서 kakao.maps.Map 생성
            - [ ] 4.2.2.2 지도 컨테이너 div 생성
            - [ ] 4.2.2.3 기본 중심좌표 설정 (부산 해운대)
            - [ ] 4.2.2.4 테스트 코드 작성
            - [ ] 4.2.2.5 테스트 실행 및 검증
            - [ ] 4.2.2.6 오류 수정 (필요 시)
        - [ ] 4.2.3 지도 줌 컨트롤 추가
        - [ ] 4.2.4 현재 위치 버튼 추가
            - [ ] 4.2.4.1 Geolocation API로 현재 위치 가져오기
            - [ ] 4.2.4.2 지도 중심 이동
            - [ ] 4.2.4.3 테스트 코드 작성
            - [ ] 4.2.4.4 테스트 실행 및 검증
            - [ ] 4.2.4.5 오류 수정 (필요 시)

    - [ ] 4.3 마커 관리 시스템 (커밋 단위)
        - [ ] 4.3.1 `src/components/map/MarkerManager.tsx` 생성
        - [ ] 4.3.2 마커 추가/제거 함수 구현
        - [ ] 4.3.3 마커 아이콘 커스터마이징
            - [ ] 4.3.3.1 안전구역 마커 (초록색)
            - [ ] 4.3.3.2 위험구역 마커 (빨간색)
            - [ ] 4.3.3.3 어업권 마커 (파란색)
            - [ ] 4.3.3.4 테스트 코드 작성
            - [ ] 4.3.3.5 테스트 실행 및 검증
            - [ ] 4.3.3.6 오류 수정 (필요 시)
        - [ ] 4.3.4 마커 클릭 이벤트 (InfoWindow 표시)
            - [ ] 4.3.4.1 테스트 코드 작성
            - [ ] 4.3.4.2 테스트 실행 및 검증
            - [ ] 4.3.4.3 오류 수정 (필요 시)

    - [ ] 4.4 안전구역 오버레이 구현 (커밋 단위)
        - [ ] 4.4.1 `src/components/map/SafetyZones.tsx` 생성
        - [ ] 4.4.2 Polygon 오버레이로 안전구역 표시
            - [ ] 4.4.2.1 boundary JSONB 데이터를 좌표 배열로 변환
            - [ ] 4.4.2.2 kakao.maps.Polygon 생성
            - [ ] 4.4.2.3 색상 코드: 안전(초록 투명), 주의(노랑 투명), 위험(빨강 투명)
            - [ ] 4.4.2.4 테스트 코드 작성
            - [ ] 4.4.2.5 테스트 실행 및 검증
            - [ ] 4.4.2.6 오류 수정 (필요 시)
        - [ ] 4.4.3 안전구역 데이터 로딩 (Supabase safety_zones 테이블)
            - [ ] 4.4.3.1 테스트 코드 작성
            - [ ] 4.4.3.2 테스트 실행 및 검증
            - [ ] 4.4.3.3 오류 수정 (필요 시)

    - [ ] 4.5 안전구역 API 구현 (커밋 단위)
        - [ ] 4.5.1 `src/app/api/map/safety-zones/route.ts` 생성
        - [ ] 4.5.2 GET 핸들러: 모든 안전구역 조회
        - [ ] 4.5.3 쿼리 파라미터로 지역 필터링 지원
        - [ ] 4.5.4 테스트 코드 작성: API 응답 테스트
        - [ ] 4.5.5 테스트 실행 및 검증
        - [ ] 4.5.6 오류 수정 (필요 시)

    - [ ] 4.6 안전도 분석 Edge Function 구현 (커밋 단위)
        - [ ] 4.6.1 `supabase/functions/analyze-safety/index.ts` 생성
        - [ ] 4.6.2 Deno 환경 설정
        - [ ] 4.6.3 안전도 계산 로직
            - [ ] 4.6.3.1 입력: 위치 좌표, 활동 타입, 시간
            - [ ] 4.6.3.2 규칙 기반 점수 계산 (0-100)
            - [ ] 4.6.3.3 기상 정보 체크 (목 데이터 또는 실제 API)
            - [ ] 4.6.3.4 어업권 중복 체크
            - [ ] 4.6.3.5 항로 근접성 체크
            - [ ] 4.6.3.6 최종 안전도 등급 결정 (GREEN/YELLOW/RED)
            - [ ] 4.6.3.7 테스트 코드 작성
            - [ ] 4.6.3.8 테스트 실행 및 검증
            - [ ] 4.6.3.9 오류 수정 (필요 시)
        - [ ] 4.6.4 Edge Function 배포: `supabase functions deploy analyze-safety`
            - [ ] 4.6.4.1 테스트 코드 작성
            - [ ] 4.6.4.2 테스트 실행 및 검증
            - [ ] 4.6.4.3 오류 수정 (필요 시)

    - [ ] 4.7 안전도 분석 서비스 구현 (커밋 단위)
        - [ ] 4.7.1 `src/lib/services/safetyService.ts` 생성
        - [ ] 4.7.2 `analyzeSafety` 함수: Edge Function 호출
        - [ ] 4.7.3 안전도 점수 → 색상 매핑 함수
        - [ ] 4.7.4 위험 요소 텍스트 생성 함수
        - [ ] 4.7.5 테스트 코드 작성: 서비스 함수 단위 테스트
        - [ ] 4.7.6 테스트 실행 및 검증
        - [ ] 4.7.7 오류 수정 (필요 시)

    - [ ] 4.8 안전도 분석 결과 UI 구현 (커밋 단위)
        - [ ] 4.8.1 `src/components/safety/SafetyAnalysis.tsx` 생성
        - [ ] 4.8.2 안전도 점수 표시 (진행 바 또는 게이지)
        - [ ] 4.8.3 안전도 등급 배지 (GREEN/YELLOW/RED)
        - [ ] 4.8.4 위험 요소 목록
            - [ ] 4.8.4.1 기상 상태
            - [ ] 4.8.4.2 어업권 충돌
            - [ ] 4.8.4.3 항로 근접
            - [ ] 4.8.4.4 테스트 코드 작성
            - [ ] 4.8.4.5 테스트 실행 및 검증
            - [ ] 4.8.4.6 오류 수정 (필요 시)
        - [ ] 4.8.5 권장사항 섹션
            - [ ] 4.8.5.1 테스트 코드 작성
            - [ ] 4.8.5.2 테스트 실행 및 검증
            - [ ] 4.8.5.3 오류 수정 (필요 시)

    - [ ] 4.9 신고 결과 페이지에 지도 통합 (커밋 단위)
        - [ ] 4.9.1 `src/app/report/[id]/page.tsx` 수정
        - [ ] 4.9.2 MapView 컴포넌트 추가
        - [ ] 4.9.3 신고 위치에 마커 표시
        - [ ] 4.9.4 주변 안전구역 오버레이 표시
        - [ ] 4.9.5 테스트 코드 작성: 지도 렌더링 확인
        - [ ] 4.9.6 테스트 실행 및 검증
        - [ ] 4.9.7 오류 수정 (필요 시)

    - [ ] 4.10 submit_report RPC 함수 업데이트 (안전도 분석 통합) (커밋 단위)
        - [ ] 4.10.1 `submit_report` 함수 수정
        - [ ] 4.10.2 Edge Function 호출 추가
        - [ ] 4.10.3 analysis_data JSONB에 안전도 분석 결과 저장
        - [ ] 4.10.4 테스트 코드 작성
        - [ ] 4.10.5 테스트 실행 및 검증
        - [ ] 4.10.6 오류 수정 (필요 시)

---

## 완료 조건
- [x] 오픈 스트리트 맵 연동
- [x] 메인 지도 컴포넌트 구현
- [x] 마커 및 오버레이 시스템 구축
- [x] 안전구역 데이터 표시
- [x] 안전도 분석 Edge Function 배포
- [x] 안전도 분석 결과 UI 렌더링
- [x] 신고 결과 페이지에 지도 통합

---

## Git 작업 흐름
```
4.1 커밋 → 4.2 커밋 → ... → 4.10 커밋
                ↓
          Task 4 Push (지도 및 안전도 분석 배포 가능)
```
